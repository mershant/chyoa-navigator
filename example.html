<div id="chyoa-navigator-drawer" class="chyoa-navigator-settings">
    <div class="inline-drawer">
        <div class="inline-drawer-toggle inline-drawer-header">
            <b>Chyoa Navigator</b>
            <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
        </div>
        <div class="inline-drawer-content">
            <!-- Enable/Disable Toggle -->
            <div
                style="margin-bottom: 15px; padding: 10px; background: #1a1a1a; border: 1px solid #444; border-radius: 5px;">
                <label class="checkbox_label" style="font-size: 1.1em; font-weight: bold;">
                    <input id="enable_toggle" type="checkbox" />
                    Enable for this chat
                </label>
                <small style="display: block; margin-top: 5px; color: #aaa;">Defaults to OFF for each new chat</small>
            </div>

            <!-- Source Text Area -->
            <div style="margin-bottom: 10px;">
                <label for="source_text">Source Text (Full Chapter)</label>
                <textarea id="source_text" class="text_pole" rows="10"
                    placeholder="Paste the full story/chapter here..."></textarea>
                <small>Highlight the part you want to rewrite.</small>
            </div>

            <!-- Selection Preview -->
            <div style="margin-bottom: 10px; padding: 5px; border: 1px solid #444; background: #222;">
                <label>Selected for Rewrite:</label>
                <div id="selection_info" style="font-size: 0.85em; color: #888; margin: 3px 0;">
                    No selection
                </div>
                <div id="selection_preview"
                    style="font-style: italic; color: #aaa; max-height: 100px; overflow-y: auto; white-space: pre-wrap;">
                    (No text selected)</div>
                <div style="margin-top: 5px; display: flex; gap: 5px;">
                    <button id="jump_to_selection_btn" class="menu_button" style="font-size: 0.9em; flex: 1;">
                        ⬆ Jump to Selection
                    </button>
                    <button id="undo_selection_btn" class="menu_button" style="font-size: 0.9em; flex: 1;">
                        ↶ Undo Selection
                    </button>
                </div>
                <div style="margin-top: 5px; border-top: 1px dashed #444; padding-top: 5px;">
                    <!-- Using button element ensures correct click behavior on all devices -->
                    <button id="manual_paste_toggle" class="menu_button" style="background: none; border: none; text-align: left; padding: 10px 0; width: 100%; display: flex; align-items: center; color: #aaa; font-size: 0.9em;">
                        <span style="font-size: 1.2em; margin-right: 5px; width: 15px; display: inline-block;">▶</span>
                        <span>Manual Selection (Paste Text)</span>
                    </button>
                    <div id="manual_paste_container" style="display: none; margin-top: 5px;">
                        <textarea id="manual_paste_input" class="text_pole" rows="3"
                            placeholder="Paste the text you want to select here..."></textarea>
                        <button id="manual_paste_btn" class="menu_button" style="margin-top: 5px; width: 100%;">
                            Find & Select in Source
                        </button>
                    </div>
                </div>
            </div>

            <!-- OOC Settings -->
            <div style="margin-bottom: 10px;">
                <label for="ooc_pre">Pre-Prompt (OOC1)</label>
                <textarea id="ooc_pre" class="text_pole" rows="3"
                    placeholder="[OOC1: Below is the scenario...]"></textarea>
            </div>

            <div style="margin-bottom: 10px;">
                <label for="ooc_post">Post-Prompt (OOC2)</label>
                <textarea id="ooc_post" class="text_pole" rows="3" placeholder="[OOC2: Your job is to...]"></textarea>
            </div>

            <!-- Toggles -->
            <div style="margin-bottom: 10px;">
                <label class="checkbox_label">
                    <input id="separate_protagonist" type="checkbox" />
                    The protagonist is separate from {{user}}
                </label>
                <small style="display: block; margin-top: 5px; margin-left: 25px; color: #aaa;">
                    The protagonist refers to the character in the source text (may be in second person). Events happen
                    to them following the source sequence, but {{user}} can experience it with/against them.
                </small>

                <!-- Protagonist Name Input -->
                <div style="margin-top: 10px; margin-left: 25px;">
                    <label for="protagonist_name">Protagonist Name:</label>
                    <input id="protagonist_name" type="text" class="text_pole" placeholder="e.g., Alex, the hero, etc."
                        disabled />
                    <small style="display: block; margin-top: 3px; color: #aaa;">Only active when "separate protagonist"
                        is enabled</small>
                </div>

                <!-- Isekai Mode Toggle -->
                <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #444;">
                    <label class="checkbox_label">
                        <input id="isekai_mode" type="checkbox" />
                        User Replaces Protagonist (Isekai Mode)
                    </label>
                    <small style="display: block; margin-top: 5px; margin-left: 0; color: #aaa;">
                        {{user}} BECOMES the protagonist with full agency. The AI acts as GM to guide you through the
                        source events.
                    </small>
                </div>
            </div>

            <!-- Injection Depth -->
            <div style="margin-bottom: 10px; border-top: 1px solid #444; padding-top: 10px;">
                <label for="injection_depth">Injection Depth (messages from end)</label>
                <input id="injection_depth" type="number" class="text_pole" min="0" value="1" />
                <small>0 = at the very end, 1 = before last message, etc.</small>
            </div>

            <!-- Test Button -->
            <div style="margin-bottom: 10px;">
                <button id="test_injection_btn" class="menu_button">Test Injection (Check Console)</button>
            </div>

            <p><small>Selection is auto-saved.</small></p>
        </div>
    </div>
</div>